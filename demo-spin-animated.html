<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Roulette — Animirani spin (v3)</title>
<style>
  :root{--bg:#0b0b0b;--panel:#151515;--edge:#2a2a2a;--txt:#eee;--accent:#ffd023}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:960px;margin:28px auto;padding:0 16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button{border:0;padding:12px 18px;border-radius:12px;background:var(--accent);font-weight:700;cursor:pointer}
  .card{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:16px;margin-top:16px}

  .stage{margin:auto;position:relative;width:min(92vw,520px);aspect-ratio:1}
  .pin{position:absolute;left:50%;top:-6px;transform:translateX(-50%); z-index:6;
       width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-bottom:16px solid var(--accent);
       filter:drop-shadow(0 0 4px rgba(0,0,0,.5))}
  /* Drveni prsten + gloss */
  .outer{position:absolute;inset:0;border-radius:50%;
    background:
      radial-gradient(closest-side, transparent 70%, rgba(0,0,0,.6) 71% 100%),
      conic-gradient(#5c3b1e, #774d28, #5c3b1e);
    box-shadow: inset 0 12px 25px rgba(0,0,0,.45), inset 0 -8px 18px rgba(0,0,0,.6);
  }
  .gloss{position:absolute;inset:6% 6% 6% 6%;border-radius:50%;
    background: radial-gradient(120% 100% at 50% -10%, rgba(255,255,255,.18), rgba(255,255,255,0) 40%);
    z-index:2; pointer-events:none;
  }

  /* Točak sa džepovima */
  .wheel{position:absolute;inset:7% 7% 7% 7%;border-radius:50%;overflow:hidden;z-index:3;
         transition:transform 5.3s cubic-bezier(.08,.82,.17,1)}
  /* Džepovi */
  .pockets{position:absolute;inset:0;border-radius:50%}
  /* conic boje (postavlja JS) */
  /* Metalne pregrade (svetlo/senka) */
  .separators{position:absolute;inset:0;border-radius:50%;
    background:
      repeating-conic-gradient(from -90deg,
        rgba(255,255,255,.35) 0deg 0.35deg,
        rgba(0,0,0,.55) 0.35deg 0.8deg,
        transparent 0.8deg 9.73deg);
    mix-blend-mode:overlay; opacity:.9; pointer-events:none;
  }

  /* Brojevi */
  .nums{position:absolute;inset:0}
  .nums span{position:absolute;left:50%;top:50%;transform-origin:0 -43%;
    font-size:clamp(11px,2.5vw,15px);font-weight:800;letter-spacing:.3px;text-shadow:0 1px 2px #000}
  .nums .red{color:#ff5d5d} .nums .black{color:#f2f2f2} .nums .zero{color:#8bff96}

  /* Hub (središte) */
  .hub{position:absolute;width:26%;aspect-ratio:1;border-radius:50%;z-index:4;
    background: radial-gradient(circle at 30% 30%,#666,#2b2b2b 60%,#121212 75%);
    border:1px solid #000; box-shadow: inset 0 6px 12px rgba(255,255,255,.05), inset 0 -6px 12px rgba(0,0,0,.6);
  }

  /* Kuglica */
  .ballRing{position:absolute;inset:10% 10% 10% 10%;border-radius:50%;z-index:5; pointer-events:none}
  .ball{position:absolute;left:50%;top:8%; transform:translateX(-50%);
    width:16px;height:16px;border-radius:50%;
    background: radial-gradient(circle at 35% 35%, #fff, #d9d9d9 55%, #aaa 70%, #666 100%);
    box-shadow: 0 2px 6px rgba(0,0,0,.7);
  }

  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--edge);border-radius:999px}
  pre{white-space:pre-wrap;background:#0f0f0f;border:1px solid var(--edge);border-radius:12px;padding:12px;overflow:auto}
  .highlight{position:absolute;inset:0;border-radius:50%; pointer-events:none; z-index:4; mix-blend-mode:screen}
</style>
</head>
<body>
<div class="wrap">
  <h1>Roulette — Animirani spin</h1>
  <div class="row"><button id="btn">Zavrti</button><span id="status" class="pill">Spreman</span></div>

  <div class="card">
    <div class="stage">
      <div class="pin"></div>
      <div class="outer"></div>
      <div class="gloss"></div>

      <div id="wheel" class="wheel" aria-label="roulette wheel">
        <div id="pockets" class="pockets"></div>
        <div class="separators"></div>
        <div class="nums" id="nums"></div>
        <div class="hub"></div>
        <div id="glow" class="highlight"></div>
      </div>

      <div id="ballRing" class="ballRing"><div class="ball"></div></div>
    </div>
  </div>

  <div class="card">
    <h3>Rezultat</h3>
    <div class="row"><div class="pill" id="short">—</div></div>
    <pre id="out">{}</pre>
  </div>
</div>

<script>
  const ORDER=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
  const REDS=new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
  const wedge=360/ORDER.length;

  const wheel=document.getElementById('wheel');
  const pocketsEl=document.getElementById('pockets');
  const numsEl=document.getElementById('nums');
  const glow=document.getElementById('glow');
  const ballRing=document.getElementById('ballRing');

  function buildPockets(){
    let parts=[];
    for(let i=0;i<ORDER.length;i++){
      const n=ORDER[i], start=i*wedge, end=(i+1)*wedge;
      const col = (n===0) ? '#1eb15a' : (REDS.has(n) ? '#c51f1f' : '#141414');
      parts.push(`${col} ${start}deg ${end}deg`);
    }
    pocketsEl.style.background=`conic-gradient(from -90deg, ${parts.join(',')})`;
  }
  function drawNumbers(){
    ORDER.forEach((n,i)=>{
      const s=document.createElement('span');
      s.textContent=String(n);
      s.className = n===0 ? 'zero' : (REDS.has(n)?'red':'black');
      const deg=i*wedge;
      s.style.transform=`translate(-50%,-50%) rotate(${deg}deg) translateY(-48%) rotate(${-deg}deg)`;
      numsEl.appendChild(s);
    });
  }
  function angleForNumber(n){
    const idx=ORDER.indexOf(n);
    return -(idx*wedge) - (wedge/2);
  }
  function showGlow(n){
    const idx=ORDER.indexOf(n);
    const start=idx*wedge-90, end=(idx+1)*wedge-90;
    glow.style.background=
      `conic-gradient(from 0deg, rgba(255,255,200,.0) ${start}deg, rgba(255,255,200,.35) ${(start+end)/2}deg, rgba(255,255,200,.0) ${end}deg)`;
  }

  let turns=0;
  async function spin(){
    document.getElementById('status').textContent='Pozivam funkciju...';
    const res=await fetch('/.netlify/functions/spin');
    const data=await res.json();
    const n=data?.result?.number ?? 0, color=data?.result?.color ?? '';

    // wheel animacija
    const target=angleForNumber(n);
    const extra=6; turns+=extra;
    const totalDeg=turns*360+target;
    wheel.style.transition='transform 5.3s cubic-bezier(.08,.82,.17,1)';
    wheel.style.transform=`rotate(${totalDeg}deg)`;

    // kuglica kruži suprotno, pa uspori
    const start=performance.now(), duration=5200;
    function tick(t){
      const p=Math.min(1,(t-start)/duration);
      // ease-out
      const e=1-Math.pow(1-p,3);
      const ballDeg = -(turns*360) * (1-e) - target*e - 30; // malo “ispred” pa u džep
      ballRing.style.transform=`rotate(${ballDeg}deg)`;
      if(p<1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // čekaj kraj
    await new Promise(r=>setTimeout(r,5300));
    turns%=10;
    wheel.style.transition='none';
    wheel.style.transform=`rotate(${target}deg)`;
    ballRing.style.transform=`rotate(${-target-30}deg)`;

    showGlow(n);
    document.getElementById('status').textContent='Gotovo';
    document.getElementById('short').textContent=`#${n} ${color}`;
    document.getElementById('out').textContent=JSON.stringify(data,null,2);
  }

  document.getElementById('btn').addEventListener('click',()=>{
    if (wheel.style.transition && wheel.style.transition.includes('transform')) return;
    spin().catch(e=>{
      document.getElementById('status').textContent='Greška';
      document.getElementById('out').textContent=String(e);
    });
  });

  buildPockets(); drawNumbers();
  wheel.style.transform=`rotate(${angleForNumber(0)}deg)`;
  showGlow(0);
</script>
</body>
</html>
