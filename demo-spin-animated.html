<!doctype html>
<html lang="sr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Roulette — Animirani spin (v2)</title>
<style>
  :root{--bg:#0b0b0b;--panel:#151515;--edge:#2a2a2a;--txt:#eee;--accent:#ffd023}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:960px;margin:28px auto;padding:0 16px}
  h1{margin:8px 0 14px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button{border:0;padding:12px 18px;border-radius:12px;background:var(--accent);font-weight:700;cursor:pointer}
  .card{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:16px;margin-top:16px}

  /* Scena */
  .stage{margin:auto;position:relative;width:min(92vw,460px);aspect-ratio:1}
  .pin{position:absolute;left:50%;top:-6px;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:14px solid var(--accent);transform:translateX(-50%);z-index:4;filter:drop-shadow(0 0 4px rgba(0,0,0,.5))}
  .outer{position:absolute;inset:0;border-radius:50%;background:radial-gradient(closest-side,#3a3a3a 72%,#111 72% 73%,#555 73% 74%,#111 74% 100%)}
  .wheel{position:absolute;inset:7% 7% 7% 7%;border-radius:50%;display:grid;place-items:center;overflow:hidden;transition:transform 5s cubic-bezier(.17,.84,.26,.99)}
  /* tanke razdelne linije između džepova preko maske */
  .wheel::after{
    content:""; position:absolute; inset:0; border-radius:50%;
    /* 37 sektora → širina sektora je ~9.73deg; poslednjih 0.6deg je linija */
    -webkit-mask: repeating-conic-gradient(#000 0deg 9.13deg, transparent 9.13deg 9.73deg);
            mask: repeating-conic-gradient(#000 0deg 9.13deg, transparent 9.13deg 9.73deg);
    background:rgba(0,0,0,.25);
    pointer-events:none;
  }
  .hub{position:absolute;width:28%;aspect-ratio:1;border-radius:50%;
    background:radial-gradient(circle at 30% 30%,#5a5a5a,#2a2a2a 60%,#111 70%);z-index:3;border:1px solid #000}
  .nums{position:absolute;inset:0;z-index:2}
  .nums span{position:absolute;left:50%;top:50%;transform-origin:0 -42%;
    font-size:clamp(11px,2.7vw,15px);font-weight:800;letter-spacing:.3px;text-shadow:0 1px 1px #000}
  .nums .red{color:#ff5d5d} .nums .black{color:#f3f3f3} .nums .zero{color:#98ff9a}

  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--edge);border-radius:999px}
  pre{white-space:pre-wrap;background:#0f0f0f;border:1px solid var(--edge);border-radius:12px;padding:12px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>Roulette — Animirani spin</h1>
  <div class="row"><button id="btn">Zavrti</button><span id="status" class="pill">Spreman</span></div>

  <div class="card">
    <div class="stage">
      <div class="pin"></div>
      <div class="outer"></div>
      <div id="wheel" class="wheel" aria-label="roulette wheel">
        <div class="nums" id="nums"></div>
        <div class="hub"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Rezultat</h3>
    <div class="row"><div class="pill" id="short">—</div></div>
    <pre id="out">{}</pre>
  </div>
</div>

<script>
  // Redosled evropskog točka u smeru kazaljke
  const ORDER=[0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
  const REDS=new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
  const wedge=360/ORDER.length; // ~9.7297°

  const wheel=document.getElementById('wheel');
  const numsEl=document.getElementById('nums');

  // Dinamički ofarbaj džepove koničnim gradijentom: zeleno 0, crno/crveno ostalo
  function buildGradient(){
    let parts=[]; // "color startdeg enddeg"
    for(let i=0;i<ORDER.length;i++){
      const n=ORDER[i];
      const start=i*wedge, end=(i+1)*wedge;
      const col = (n===0) ? '#2ecc71' : (REDS.has(n) ? '#e74c3c' : '#1f1f1f');
      parts.push(`${col} ${start}deg ${end}deg`);
    }
    // -90deg tako da "gore" bude centar prvog sektora
    wheel.style.background = `conic-gradient(from -90deg, ${parts.join(',')})`;
  }

  // Brojevi na obodu
  function drawNumbers(){
    ORDER.forEach((n,i)=>{
      const s=document.createElement('span');
      s.textContent=String(n);
      s.className = n===0 ? 'zero' : (REDS.has(n)?'red':'black');
      const deg=i*wedge;
      s.style.transform=`translate(-50%,-50%) rotate(${deg}deg) translateY(-48%) rotate(${-deg}deg)`;
      numsEl.appendChild(s);
    });
  }

  function angleForNumber(n){
    const idx=ORDER.indexOf(n);
    // ciljna orijentacija: centar sectorа na vrh → minus pola sektora
    return -(idx*wedge) - (wedge/2);
  }

  let currentTurns=0;
  async function spin(){
    document.getElementById('status').textContent='Pozivam funkciju...';
    const res=await fetch('/.netlify/functions/spin');
    const data=await res.json();
    const n=data?.result?.number ?? 0;
    const color=data?.result?.color ?? '';

    const target=angleForNumber(n);
    const extraTurns=6; currentTurns+=extraTurns;
    const totalDeg=currentTurns*360+target;

    wheel.style.transition='transform 5s cubic-bezier(.17,.84,.26,.99)';
    wheel.style.transform=`rotate(${totalDeg}deg)`;
    document.getElementById('status').textContent='Vrti se...';
    await new Promise(r=>setTimeout(r,5100));

    currentTurns=currentTurns%10;
    wheel.style.transition='none';
    wheel.style.transform=`rotate(${target}deg)`;

    document.getElementById('status').textContent='Gotovo';
    document.getElementById('short').textContent=`#${n} ${color}`;
    document.getElementById('out').textContent=JSON.stringify(data,null,2);
  }

  document.getElementById('btn').addEventListener('click',()=>{
    if (wheel.style.transition && wheel.style.transition.includes('transform')) return;
    spin().catch(e=>{
      document.getElementById('status').textContent='Greška';
      document.getElementById('out').textContent=String(e);
    });
  });

  // Init
  buildGradient(); drawNumbers();
  wheel.style.transform=`rotate(${angleForNumber(0)}deg)`;
</script>
</body>
</html>
